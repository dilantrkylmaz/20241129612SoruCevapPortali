@using System.Security.Claims
@using _20241129612SoruCevapPortalı.Repositories.Abstract
@using _20241129612SoruCevapPortalı.Models
@inject IRepository<User> UserRepo
@{
    User currentUser = null;
    if (User.Identity.IsAuthenticated)
    {
        string currentUserName = User.Identity.Name;
        if (!string.IsNullOrEmpty(currentUserName))
        {
            currentUser = UserRepo.Get(x => x.UserName == currentUserName);
        }
    }

    string userImg = (!string.IsNullOrEmpty(currentUser?.ProfileImageUrl))
        ? currentUser.ProfileImageUrl
        : "/img/default-user.png";

    string UserName = currentUser?.FullName ?? "Yönetici";
}

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Soru Cevap Portalı</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini">
    <div class="wrapper">

        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
                </li>
            </ul>

            <ul class="navbar-nav ml-auto">
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="/" class="nav-link btn btn-outline-primary text-primary btn-sm mr-2">
                        <i class="fas fa-globe"></i> Siteye Dön
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/Account/Logout" class="nav-link btn btn-danger text-white btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Çıkış
                    </a>
                </li>

                <li class="nav-item d-none d-sm-inline-block">
                    <a href="/Admin/Profile/Index" class="nav-link">
                        <i class="fas fa-user"></i> Profilim
                    </a>
                </li>
            </ul>
        </nav>
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <a href="/Admin/Dashboard" class="brand-link">
                <span class="brand-text font-weight-light px-3">YÖNETİCİ PANELİ</span>
            </a>

            <div class="sidebar">
                <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                    <div class="image">
                        <img src="@userImg"
                             class="img-circle elevation-2"
                             alt="User Image"
                             style="width: 35px; height: 35px; object-fit: cover;">
                    </div>
                    <div class="info">
                        <a href="/Admin/Profile/Index" class="d-block">@UserName</a>
                    </div>
                </div>

                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">

                        <li class="nav-header">İÇERİK YÖNETİMİ</li>

                        <li class="nav-item">
                            <a href="/Admin/Dashboard" class="nav-link">
                                <i class="nav-icon fas fa-tachometer-alt"></i>
                                <p>Özet (Dashboard)</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="/Admin/Category/Index" class="nav-link">
                                <i class="nav-icon fas fa-list"></i>
                                <p>Kategoriler</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="/Admin/Question/Index" class="nav-link">
                                <i class="nav-icon fas fa-question-circle"></i>
                                <p>Sorular</p>
                            </a>
                        </li>

                        <li class="nav-item">
                            <a href="/Admin/Answer/Index" class="nav-link">
                                <i class="nav-icon fas fa-comments"></i>
                                <p>Cevaplar</p>
                            </a>
                        </li>

                        <li class="nav-header">KULLANICI İŞLEMLERİ</li>

                        <li class="nav-item">
                            <a href="/Admin/User/Index" class="nav-link">
                                <i class="nav-icon fas fa-users"></i>
                                <p>Üyeler</p>
                            </a>
                        </li>

                    </ul>
                </nav>
            </div>
        </aside>

        <div class="content-wrapper">
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">@ViewData["Title"]</h1>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <div class="container-fluid">
                    @RenderBody()
                </div>
            </div>
        </div>
        <footer class="main-footer">
            <div class="float-right d-none d-sm-inline">
                Soru Cevap Portalı v1.0
            </div>
            <strong>Copyright &copy; 2025.</strong> Tüm hakları saklıdır.
        </footer>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        var connection = new signalR.HubConnectionBuilder().withUrl("/portalHub").build();
        connection.on("ReceiveNotification", function (user, title) {
            alert("Yeni Soru: " + user + " tarafından '" + title + "' başlığıyla bir soru soruldu!");
            // İsterseniz burada toastr veya benzeri bir kütüphane ile daha şık bir bildirim yapabilirsiniz.
        });
        connection.start();
    </script>
    @await RenderSectionAsync("Scripts", required: false)
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        // SignalR Hub bağlantısını oluştur (Program.cs'deki map edilen isimle aynı olmalı)
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("/portalHub")
            .build();

        // Sunucudan (Controller'dan) gelecek olan "ReceiveNotification" mesajını dinle
        connection.on("ReceiveNotification", function (user, title) {
            // Yeni bir soru geldiğinde ekranda uyarı göster
            // Not: Gerçek bir projede alert yerine Toastr gibi kütüphaneler daha şıktır.
            alert("BİLDİRİM: " + user + " isimli kullanıcı '" + title + "' başlıklı yeni bir soru sordu!");
        });

        // Bağlantıyı başlat
        connection.start().then(function () {
            console.log("SignalR bağlantısı başarıyla kuruldu.");
        }).catch(function (err) {
            return console.error("SignalR bağlantı hatası: " + err.toString());
        });
    </script>
</body>
</html>